#!/bin/bash

MTPROXY_DIR="/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy"
RELEASE_DIR="$MTPROXY_DIR/_build/prod/rel/mtp_proxy"

# Check if the proxy was built properly
if [ ! -d "$RELEASE_DIR" ]; then
    echo "MTProxy Erlang release not found at $RELEASE_DIR"
    echo "Falling back to tgo implementation..."
    cd /opt/hiddify-manager/other/telegram/tgo && bash install.sh && bash run.sh
    exit $?
fi

cd "$MTPROXY_DIR" || exit 1

# Ensure config directory exists
mkdir -p config

# Create vm.args if not exists
if [ ! -f config/prod-vm.args ]; then
    if [ -f config/vm.args.example ]; then
        cp config/vm.args.example config/prod-vm.args
    else
        cat > config/prod-vm.args << 'VMARGS'
-name mtp_proxy@127.0.0.1
-setcookie mtproto_proxy
+K true
+A 10
-env ERL_MAX_PORTS 65536
VMARGS
    fi
fi

# Copy the main config file
cp /opt/hiddify-manager/other/telegram/erlang/prod-sys.config config/prod-sys.config
chmod 600 config/prod-sys.config

# Create log directory
mkdir -p /var/log/mtproto-proxy
chmod 755 /var/log/mtproto-proxy

# Create start.sh script that runs the proxy in foreground
cat > "$MTPROXY_DIR/start.sh" << 'STARTEOF'
#!/bin/bash
cd /opt/hiddify-manager/other/telegram/erlang/mtproto_proxy
export HOME=/root
# Run in foreground mode
./_build/prod/rel/mtp_proxy/bin/mtp_proxy foreground 2>&1
STARTEOF
chmod +x "$MTPROXY_DIR/start.sh"

# Create/update systemd service
cat > /etc/systemd/system/mtproxy.service << 'EOF'
[Unit]
Description=Erlang MTProto Proxy (seriyps)
Documentation=https://github.com/seriyps/mtproto_proxy
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy
ExecStart=/opt/hiddify-manager/other/telegram/erlang/mtproto_proxy/start.sh
ExecStop=/bin/kill -TERM $MAINPID
Restart=always
RestartSec=5
LimitNOFILE=65535
StandardOutput=file:/opt/hiddify-manager/log/system/telegram.out.log
StandardError=file:/opt/hiddify-manager/log/system/telegram.err.log

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable mtproxy.service
systemctl restart mtproxy.service

sleep 3
if systemctl is-active --quiet mtproxy.service; then
    echo "MTProxy Erlang started successfully!"
    systemctl status mtproxy --no-pager
else
    echo "MTProxy Erlang failed to start, falling back to tgo..."
    systemctl stop mtproxy.service
    cd /opt/hiddify-manager/other/telegram/tgo && bash install.sh && bash run.sh
fi
