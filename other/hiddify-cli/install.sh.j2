#!/bin/bash
source ../../common/utils.sh

useradd -m hiddify-cli -s /bin/bash >/dev/null 2>&1

latest=$(get_release_version Hiddify-Custom-Core)

if [ -z "$latest" ]; then
    echo "Warning: Could not get version, downloading latest..."
    latest="latest"
fi

if [ "$(cat 'VERSION' 2>/dev/null)" != "$latest" ] || ! is_installed ./hiddify-cli; then
    echo "Downloading hiddify-cli..."
    pkg=$(dpkg --print-architecture)

    if [ "$latest" == "latest" ]; then
        curl -sLo hiddify-cli.tar.gz "https://github.com/mn-hacker/Hiddify-Custom-Core/releases/latest/download/hiddify-cli-linux-$pkg.tar.gz"
    else
        curl -sLo hiddify-cli.tar.gz "https://github.com/mn-hacker/Hiddify-Custom-Core/releases/download/v$latest/hiddify-cli-linux-$pkg.tar.gz"
    fi

    tar -xzf hiddify-cli.tar.gz
    rm hiddify-cli.tar.gz
    # Move binaries from nested directory if present (build creates hiddify-cli-linux-*/hiddify-cli)
    if ls hiddify-cli-linux-*/hiddify-cli 2>/dev/null; then
        mv hiddify-cli-linux-*/hiddify-cli ./hiddify-cli
        cp hiddify-cli-linux-*/lib/*.so ./lib/ 2>/dev/null || true
        rm -rf hiddify-cli-linux-*/
    fi
    rm -f HiddifyCli # Cleanup legacy binary
    chmod +x hiddify-cli
    echo $latest> VERSION
fi

if [ ! -d "ui" ]; then
    echo "Downloading Yacd UI..."
    mkdir -p ui
    curl -sLo ui.zip "https://mirror.ghproxy.com/https://github.com/MetaCubeX/Yacd-meta/archive/gh-pages.zip"
    unzip -q -o ui.zip -d ui/
    mv ui/Yacd-meta-gh-pages/* ui/ 2>/dev/null
    rm -rf ui/Yacd-meta-gh-pages ui.zip
fi


ln -sf /opt/hiddify-manager/other/hiddify-cli/hiddify-cli.service /etc/systemd/system/hiddify-cli.service
systemctl enable hiddify-cli.service